<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Demo account</title>
  <meta name="company-description" content="Always respond in the same language as was written.">
  <style>
    body { background-color:#f9f9f9; font-family:Arial,sans-serif; height:100vh; margin:0; }

    #gate { position:fixed; inset:0; background:#0b172033; display:flex; align-items:center; justify-content:center; z-index:9999; backdrop-filter:blur(6px); }
    .gate-card { background:#fff; width:90%; max-width:420px; padding:24px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.15); text-align:center; }
    .gate-card h3 { margin:0 0 8px; color:#007b5e; }
    .gate-card p { margin:0 0 16px; color:#555; }
    .gate-card input[type="password"]{ width:100%; padding:12px; font-size:16px; border:1px solid #ccc; border-radius:8px; margin-bottom:12px; }
    .gate-card button{ width:100%; padding:12px; font-size:16px; border:none; border-radius:8px; background:#007b5e; color:#fff; cursor:pointer; }
    .gate-card button:hover{ background:#005c49; }
    .gate-error{ color:#c02727; min-height:22px; margin-top:8px; font-size:14px; }

    #app{ display:none; }

    .wrap{ display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding-top:30px; }
    .chat-box{ background:#fff; padding:30px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.1); width:90%; max-width:600px; text-align:center; margin:30px auto; }
    img.logo{ width:150px; margin-bottom:10px; }
    h1{ color:#007b5e; margin:10px 0 5px 0; font-size:32px; }
    h2{ color:#555; margin:0 0 10px 0; font-size:16px; font-weight:normal; }

    /* Unified control sizing */
    .field-wrap { width:80%; margin:0 auto 10px; }
    .field-wrap input,
    .field-wrap button,
    .field-wrap select {
      width:100%;
      padding:12px;
      font-size:16px;
      border:1px solid #ccc;
      border-radius:6px;
      box-sizing:border-box;
    }
    button{ background-color:#007b5e; color:#fff; cursor:pointer; }
    button:hover{ background-color:#005c49; }

    /* Checkbox row aligned with inputs */
    .control-row { width:80%; margin:4px auto 6px; display:flex; align-items:center; gap:10px; text-align:left; }
    .control-row input[type="checkbox"]{ width:auto; margin:0; }
    .control-row label{ font-size:14px; color:#555; user-select:none; }

    /* Hide preset until toggled */
    #presetWrap { display:none; }

    pre{ margin-top:20px; text-align:left; background:#f0f0f0; padding:15px; border-radius:6px; white-space:pre-wrap; word-wrap:break-word; min-height:50px; }
  </style>
</head>
<body>

  <!-- Password gate -->
  <div id="gate" aria-modal="true" role="dialog">
    <div class="gate-card">
      <h3>AHV secure demo</h3>
      <p>Enter the password to continue.</p>
      <input id="pw" type="password" placeholder="Password" autocomplete="current-password" />
      <button id="enter">Unlock</button>
      <div class="gate-error" id="gateError"></div>
    </div>
  </div>

  <!-- App -->
  <div id="app">
    <div class="wrap">
      <div class="chat-box">
        <img class="logo" src="ahv-logo.jpg" alt="AHV logo" />
        <h1>Demo account</h1>
        <h2>In this demo, you can ask questions about the farm, cows, or sales from the past 12 months for farms 406051 (NL), 066526303 (GB), DE010550444423 (DE), and 42213083 (FR).</h2>

        <div class="field-wrap">
          <input id="ubnInput" placeholder="Enter your UBN (farm registration number)..." />
        </div>

        <!-- Free text (visible only when presets are OFF) -->
        <div id="userInputWrap" class="field-wrap">
          <input id="userInput" placeholder="Type your question here in English, Dutch, German or French ..." />
        </div>

        <!-- Preset dropdown (visible only when presets are ON) -->
        <div id="presetWrap" class="field-wrap">
          <select id="presetSelect" aria-label="Suggested questions">
            <option value="">— Choose a preset question —</option>
            <option>Analyze the last 12 months of orders and herd data; identify missing product families and cross-sell or upsell opportunities.</option>
            <option>Using last order date and revenue trends, estimate the chance of a new sale if I visit this month.</option>
            <option>From the latest MPR, what % of cows expected to dry off in the next 30 days are producing over 20 kg and over 25 kg milk?</option>
            <option>For cows ≤60 DIM in the latest MPR, what % have FPR ≥1.40 at first and second milk recording?</option>
            <option>Show the herd’s average milk yield curve from calving to 100 DIM using the last 12 months of MPR data and note any >30% drops.</option>
            <option>In the latest MPR, how many cows have SCC >200k (heifers >100k)? Indicate chronic vs good-prognosis animals.</option>
            <option>Compare SCC before dry-off and first SCC after calving for cows dried off in the last 6 months; summarize udder health changes.</option>
            <option>For cows ≤100 DIM in the latest MPR, compare milk yield vs expected, flag ketosis risk and FPR ≥1.40, and mark ≥30% milk drops.</option>
            <option>How many cows are due to dry off in the next 3 months and what is their current milk yield?</option>
            <option>Create three lists from the latest MPR: metabolic risk, active udder protocol need (DIM 7–100 & SCC ≥100k), and dry-off risk (milk >20kg and/or SCC >200k within 30 days).</option>
          </select>
        </div>

        <!-- Toggle BELOW whichever input is shown -->
        <div class="control-row">
          <input type="checkbox" id="togglePresets" />
          <label for="togglePresets">Show suggested questions</label>
        </div>

        <div class="field-wrap">
          <button onclick="sendToGPT()">Send</button>
        </div>

        <pre id="response">Answer will appear here...</pre>
      </div>

      <!--
      Use case 3: AHV / Photo Upload Section (disabled for now)
      <div class="chat-box" style="opacity:0.4; pointer-events:none;">
        <h2>Upload a photo of the completed treatment card using your phone</h2>
        <input type="file" id="imageUpload" accept="image/*" />
        <br />
        <button onclick="uploadImage()">Send</button>
        <pre id="imageResponse">Answer will appear here...</pre>
        <div class="file-preview" id="filePreview"></div>
      </div>
      -->
    </div>
  </div>

  <script>
    const PASS_HASH = "234f1d8746bbd3d0b3a236243b96f8c353c7625c4af41f3d86aac4f239a7e2d0"; // SHA-256 of "AHVDemo123!"

    async function sha256Hex(str) {
      const buf = new TextEncoder().encode(str);
      const hash = await crypto.subtle.digest("SHA-256", buf);
      return [...new Uint8Array(hash)].map(b => b.toString(16).padStart(2, "0")).join("");
    }

    async function unlock() {
      const pw = document.getElementById("pw").value || "";
      const err = document.getElementById("gateError");
      const hex = await sha256Hex(pw);
      if (hex === PASS_HASH) {
        document.getElementById("gate").style.display = "none";
        document.getElementById("app").style.display = "block";
        // Focus whichever control is visible
        setTimeout(() => {
          const t = document.getElementById("togglePresets").checked;
          (t ? document.getElementById("presetSelect") : document.getElementById("userInput")).focus();
        }, 0);
      } else {
        err.textContent = "Incorrect password.";
      }
    }
    document.getElementById("enter").addEventListener("click", unlock);
    document.getElementById("pw").addEventListener("keydown", e => { if (e.key === "Enter") unlock(); });

    const companyName = "TestAccount";
    const companyDescription = document.querySelector('meta[name="company-description"]').content;

    function detectLanguage(text) {
      const t = (text || "").trim().toLowerCase();
      if (!t) return null;
      const nl=/\b(hoe|waarom|wanneer|welke|met|en|de|het|een|koe|uier|celgetal|omzet|factuur)\b/;
      const fr=/\b(quoi|pourquoi|quand|le|la|les|des|vache|mamelle|cellules|facture|chiffre)\b/;
      const de=/\b(was|warum|wann|welche|und|die|der|das|kuh|euter|zellen|rechnung|umsatz)\b/;
      const en=/\b(what|why|when|which|and|the|cow|udder|cells|invoice|revenue)\b/;
      if (nl.test(t)) return "nl";
      if (fr.test(t)) return "fr";
      if (de.test(t)) return "de";
      if (en.test(t)) return "en";
      const nav=(navigator.language||navigator.userLanguage||"nl").slice(0,2);
      if (["nl","en","fr","de"].includes(nav)) return nav;
      return "nl";
    }

    const togglePresets = document.getElementById("togglePresets");
    const presetWrap   = document.getElementById("presetWrap");
    const presetSelect = document.getElementById("presetSelect");
    const userInputWrap= document.getElementById("userInputWrap");
    const userInputEl  = document.getElementById("userInput");

    // Toggle visibility: presets OR free text
    function updateMode() {
      const on = togglePresets.checked;
      presetWrap.style.display   = on ? "block" : "none";
      userInputWrap.style.display= on ? "none"  : "block";
      if (on) { userInputEl.value = ""; presetSelect.focus(); }
      else    { presetSelect.value = ""; userInputEl.focus(); }
    }
    togglePresets.addEventListener("change", updateMode);

    async function sendToGPT() {
      const usingPreset = togglePresets.checked;
      const message = usingPreset ? (presetSelect.value || "").trim()
                                  : (userInputEl.value || "").trim();

      const ubn = document.getElementById("ubnInput").value.trim();
      const responseEl = document.getElementById("response");
      responseEl.innerText = "Thinking… answer will appear in 30 seconds.";
      const inputLang = detectLanguage(message);

      try {
        const payload = {
          company_name: companyName,
          company_description: companyDescription,
          message,
          input_language: inputLang
        };
        if (ubn) payload.ubn = ubn;

        const res = await fetch("https://hook.eu2.make.com/u2luxbx3o1wihpsbysz8gelret1x0jze", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-User-Language": inputLang || ""
          },
          body: JSON.stringify(payload)
        });

        const reply = await res.text();
        responseEl.innerText = reply || "No answer received.";
      } catch (err) {
        responseEl.innerText = "Error: " + err.message.";
      }
    }
  </script>
</body>
</html>
