<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Demo account</title>
  <meta name="company-description" content="Always respond in the same language as was written.">
  <style>
    body { background-color:#f9f9f9; font-family:Arial,sans-serif; height:100vh; margin:0; }

    /* Soft gate */
    #gate { position:fixed; inset:0; background:#0b172033; display:flex; align-items:center; justify-content:center; z-index:9999; backdrop-filter:blur(6px); }
    .gate-card { background:#fff; width:90%; max-width:420px; padding:24px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.15); text-align:center; }
    .gate-card h3 { margin:0 0 8px; color:#007b5e; }
    .gate-card p { margin:0 0 16px; color:#555; }
    .gate-card input[type="password"]{ width:100%; padding:12px; font-size:16px; border:1px solid #ccc; border-radius:8px; margin-bottom:12px; }
    .gate-card button{ width:100%; padding:12px; font-size:16px; border:none; border-radius:8px; background:#007b5e; color:#fff; cursor:pointer; }
    .gate-card button:hover{ background:#005c49; }
    .gate-error{ color:#c02727; min-height:22px; margin-top:8px; font-size:14px; }

    #app{ display:none; }

    /* App */
    .wrap{ display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding-top:30px; }
    .chat-box{ background:#fff; padding:30px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.1); width:90%; max-width:600px; text-align:center; margin:30px auto; }
    img.logo{ width:150px; margin-bottom:10px; }
    h1{ color:#007b5e; margin:10px 0 5px 0; font-size:32px; }
    h2{ color:#555; margin:0 0 10px 0; font-size:16px; font-weight:normal; }
    input, button, select{ width:80%; padding:12px; font-size:16px; margin-bottom:10px; border:1px solid #ccc; border-radius:6px; }
    button{ background-color:#007b5e; color:#fff; cursor:pointer; }
    button:hover{ background-color:#005c49; }
    .row { display:flex; align-items:center; justify-content:center; gap:10px; }
    .row label{ font-size:14px; color:#555; user-select:none; }
    .row input[type="checkbox"]{ width:auto; margin:0; }
    #presetSelect{ display:none; } /* hidden until checkbox checked */
    .subtle{ color:#777; font-size:14px; margin-top:-6px; margin-bottom:10px; display:block; }
    pre{ margin-top:20px; text-align:left; background:#f0f0f0; padding:15px; border-radius:6px; white-space:pre-wrap; word-wrap:break-word; min-height:50px; }
  </style>
</head>
<body>

  <!-- Password gate -->
  <div id="gate" aria-modal="true" role="dialog">
    <div class="gate-card">
      <h3>Beveiligde demo</h3>
      <p>Voer het wachtwoord in om verder te gaan.</p>
      <input id="pw" type="password" placeholder="Wachtwoord" autocomplete="current-password" />
      <button id="enter">Ontgrendelen</button>
      <div class="gate-error" id="gateError"></div>
    </div>
  </div>

  <!-- App -->
  <div id="app">
    <div class="wrap">
      <div class="chat-box">
        <img class="logo" src="ahv-logo.jpg" alt="AHV logo" />
        <h1>Demo account</h1>
        <h2>In this demo, you can ask questions about the farm, cows, or sales from the past 12 months for farms 406051 (NL), 066526303 (GB), DE010550444423 (DE), and 42213083 (FR).</h2>

        <input id="ubnInput" placeholder="Enter your UBN (farm registration number)..." />

        <!-- Free-text first -->
        <input id="userInput" placeholder="Type your question here in English, Dutch, German or French ..." />

        <!-- Checkbox to reveal suggestions -->
        <div class="row" style="margin:4px 0 2px;">
          <input type="checkbox" id="togglePresets" />
          <label for="togglePresets">Show suggested questions</label>
        </div>

        <!-- Preset dropdown (hidden until checkbox is ticked) -->
        <select id="presetSelect" aria-label="Suggested questions">
          <option value="">— Choose a preset question —</option>
          <option>Do you have the top 5 questions that you normally ask</option>
          <option>List of cows with risk of metabolic issues</option>
          <option>List of cows that need an active udder protocol (0-100 DIM)</option>
          <option>List of cows that need a close look for udder health, eventually AHV protocol</option>
          <option>Milk yield at dry off for the next month, and Udder score risk (to be determined)</option>
        </select>
        <span class="subtle">Tick the box to show presets, or just type your own question.</span>

        <button onclick="sendToGPT()">Send</button>
        <pre id="response">Answer will appear here...</pre>
      </div>
    </div>
  </div>

  <script>
    // ====== Soft password gate ======
    const PASS_HASH = "234f1d8746bbd3d0b3a236243b96f8c353c7625c4af41f3d86aac4f239a7e2d0"; // SHA-256 of "AHVDemo123!"

    async function sha256Hex(str) {
      const buf = new TextEncoder().encode(str);
      const hash = await crypto.subtle.digest("SHA-256", buf);
      return [...new Uint8Array(hash)].map(b => b.toString(16).padStart(2, "0")).join("");
    }

    async function unlock() {
      const pw = document.getElementById("pw").value || "";
      const err = document.getElementById("gateError");
      const hex = await sha256Hex(pw);
      if (hex === PASS_HASH) {
        document.getElementById("gate").style.display = "none";
        document.getElementById("app").style.display = "block";
        // focus the question field first
        setTimeout(() => document.getElementById("userInput").focus(), 0);
      } else {
        err.textContent = "Onjuist wachtwoord.";
      }
    }
    document.getElementById("enter").addEventListener("click", unlock);
    document.getElementById("pw").addEventListener("keydown", e => { if (e.key === "Enter") unlock(); });

    // ====== Existing app code ======
    const companyName = "TestAccount";
    const companyDescription = document.querySelector('meta[name="company-description"]').content;

    // Language detector
    function detectLanguage(text) {
      const t = (text || "").trim().toLowerCase();
      if (!t) return null;
      const nl=/\b(hoe|waarom|wanneer|welke|met|en|de|het|een|koe|uier|celgetal|omzet|factuur)\b/;
      const fr=/\b(quoi|pourquoi|quand|le|la|les|des|vache|mamelle|cellules|facture|chiffre)\b/;
      const de=/\b(was|warum|wann|welche|und|die|der|das|kuh|euter|zellen|rechnung|umsatz)\b/;
      const en=/\b(what|why|when|which|and|the|cow|udder|cells|invoice|revenue)\b/;
      if (nl.test(t)) return "nl";
      if (fr.test(t)) return "fr";
      if (de.test(t)) return "de";
      if (en.test(t)) return "en";
      const nav=(navigator.language||navigator.userLanguage||"nl").slice(0,2);
      if (["nl","en","fr","de"].includes(nav)) return nav;
      return "nl";
    }

    // Preset toggle + autofill
    const togglePresets = document.getElementById("togglePresets");
    const presetSelect  = document.getElementById("presetSelect");
    const userInputEl   = document.getElementById("userInput");

    togglePresets.addEventListener("change", () => {
      presetSelect.style.display = togglePresets.checked ? "block" : "none";
      if (!togglePresets.checked) presetSelect.value = "";
    });

    presetSelect.addEventListener("change", () => {
      const v = presetSelect.value.trim();
      if (v) userInputEl.value = v;
      userInputEl.focus();
    });

    // Chat function
    async function sendToGPT() {
      const input = userInputEl.value.trim();
      const ubn = document.getElementById("ubnInput").value.trim();
      const responseEl = document.getElementById("response");
      responseEl.innerText = "Thinking… answer will appear in 30 seconds.";
      const inputLang = detectLanguage(input);

      try {
        const payload = {
          company_name: companyName,
          company_description: companyDescription,
          message: input,
          input_language: inputLang
        };
        if (ubn) payload.ubn = ubn;

        const res = await fetch("https://hook.eu2.make.com/u2luxbx3o1wihpsbysz8gelret1x0jze", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-User-Language": inputLang || ""
          },
          body: JSON.stringify(payload)
        });

        const reply = await res.text();
        responseEl.innerText = reply || "Geen antwoord ontvangen.";
      } catch (err) {
        responseEl.innerText = "Fout: " + err.message;
      }
    }
  </script>
</body>
</html>
