<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Demo account</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="company-description" content="Always respond in the same language as was written.">
  <style>
    body { background-color:#f9f9f9; font-family:Arial,sans-serif; height:100vh; margin:0; }

    /* Password gate */
    #gate { position:fixed; inset:0; background:#0b172033; display:flex; align-items:center; justify-content:center; z-index:9999; backdrop-filter:blur(6px); }
    .gate-card { background:#fff; width:90%; max-width:420px; padding:24px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.15); text-align:center; }
    .gate-card h3 { margin:0 0 8px; color:#007b5e; }
    .gate-card p { margin:0 0 16px; color:#555; }
    .gate-card input[type="password"]{ width:100%; padding:12px; font-size:16px; border:1px solid #ccc; border-radius:8px; margin-bottom:12px; }
    .gate-card button{ width:100%; padding:12px; font-size:16px; border:none; border-radius:8px; background:#007b5e; color:#fff; cursor:pointer; }
    .gate-card button:hover{ background:#005c49; }
    .gate-error{ color:#c02727; min-height:22px; margin-top:8px; font-size:14px; }

    #app{ display:none; }

    /* App card */
    .wrap{ display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding-top:30px; }
    .chat-box{
      background:#fff; padding:30px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.1); width:90%; max-width:1100px; text-align:center; margin:30px auto;
    }
    img.logo{ width:150px; margin-bottom:10px; }
    h1{ color:#007b5e; margin:10px 0 5px 0; font-size:32px; }
    h2{ color:#555; margin:0 0 10px 0; font-size:16px; font-weight:normal; }

    .field-wrap {
      width:90%; margin:0 auto 10px; text-align:left;
    }
    .field-wrap input, .field-wrap button, .field-wrap select {
      width:100%; padding:12px; font-size:16px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;
    }
    .control-row { width:90%; margin:4px auto 6px; display:flex; align-items:center; gap:10px; text-align:left; }

    pre{ margin:20px auto 0; text-align:left; background:#f0f0f0; padding:15px; border-radius:6px; white-space:pre-wrap; word-wrap:break-word; min-height:50px; width:100%; box-sizing:border-box; }

    .download-row{ display:none; width:100%; margin:8px auto 0; gap:8px; justify-content:flex-start; align-items:center; flex-wrap:wrap; }

    .hint { font-size:13px; color:#4b5563; margin-top:6px; }
    .hint .ok { color:#065f46; }
    .hint .warn { color:#9a3412; }

    .file-preview{ margin-top:10px; text-align:left; font-size:14px; color:#374151; background:#f9fafb; border:1px dashed #d1d5db; padding:10px; border-radius:8px; }
    .file-preview img{ max-width:100%; height:auto; border-radius:6px; }

    /* Typing caret + animation */
    .typing-caret::after { content: "▍"; animation: blink 1s steps(1) infinite; }
    @keyframes blink { 50% { opacity: 0; } }
    .thinking::after { content: " ."; animation: dots 1.2s steps(3, end) infinite; }
    @keyframes dots {
      0% { content: " ."; }
      33% { content: " .."; }
      66% { content: " ..."; }
      100% { content: " ."; }
    }

    @media (max-width: 640px) {
      .chat-box{ padding:20px; width:95%; }
      img.logo{ width:120px; }
      h1{ font-size:26px; }
      h2{ font-size:14px; }
    }

  </style>
</head>
<body>

  <!-- Password gate -->
  <div id="gate" aria-modal="true" role="dialog">
    <div class="gate-card">
      <h3>AHV secure demo</h3>
      <p>Enter the password to continue.</p>
      <input id="pw" type="password" placeholder="Password" autocomplete="current-password" />
      <button id="enter">Unlock</button>
      <div class="gate-error" id="gateError"></div>
    </div>
  </div>

  <!-- App -->
  <div id="app">
    <div class="wrap">
      <div class="chat-box">
        <img class="logo" src="ahv-logo.jpg" alt="AHV logo" />
        <h1>Demo account</h1>

        <!-- Farm picker dropdown (Farm Name, UBN, Country Code search) -->
        <h2>Select a farm</h2>
        <div class="field-wrap">
          <input type="text" id="farmSearch" placeholder="Search farms by name, country code or UBN" />
        </div>
        <div class="field-wrap">
          <select id="farmSelect">
            <option value="">— Select a farm —</option>
          </select>
        </div>
        
        <div id="farmNameHint" class="hint"></div>

        <!-- Free text input (question to ask) -->
        <div id="userInputWrap" class="field-wrap">
          <input id="userInput" placeholder="Type your question here in English, Dutch, German or French ..." />
        </div>

        <!-- Send button -->
        <div class="field-wrap">
          <button onclick="sendToGPT()" id="sendBtn">Send</button>
        </div>

        <pre id="response">Answer will appear here...</pre>

        <!-- Download buttons -->
        <div class="download-row" id="downloadRow">
          <button class="small-btn" onclick="downloadDocx()">Download .docx</button>
          <button class="small-btn" onclick="downloadPDF()">Download PDF</button>
        </div>
      </div>

      <!-- Use case 3: Photo Upload Section -->
      <div class="chat-box" id="photoBox">
        <h2>Upload a photo of the completed treatment card using your phone</h2>
        <div class="field-wrap">
          <input type="file" id="imageUpload" accept="image/png,image/jpeg" />
        </div>
        <div class="field-wrap">
          <button onclick="uploadImage()" id="imageBtn">Verstuur</button>
        </div>
        <pre id="imageResponse">Answer will appear here...</pre>
        <button id="openEditorFromImage" class="small-btn" style="display:none;">Open editor</button>

        <div class="file-preview" id="filePreview"></div>
      </div>
    </div>
  </div>

  <!-- DOCX + PDF helpers -->
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    const FARM_INDEX = new Map();  // To store farm data (UBN as key)
    let FARM_LIST = []; // List of farm data for selection

    // Function to populate farm dropdown
    function populateFarmSelect(farms) {
      const farmSelect = document.getElementById('farmSelect');
      farmSelect.innerHTML = `<option value="">— Select a farm —</option>`;
      farms.forEach(farm => {
        const option = document.createElement("option");
        option.value = farm.ubn;
        option.textContent = `${farm.name} (${farm.country}) - ${farm.ubn}`;
        farmSelect.appendChild(option);
      });
    }

    // Filter farms based on search input
    function filterFarms(query) {
      const searchQuery = query.toLowerCase();
      const filteredFarms = FARM_LIST.filter(farm => {
        return farm.name.toLowerCase().includes(searchQuery) ||
               farm.ubn.includes(searchQuery) ||
               farm.country.toLowerCase().includes(searchQuery);
      });
      populateFarmSelect(filteredFarms);
    }

    // Function to handle farm selection and show farm name
    function handleFarmSelection(event) {
      const selectedUBN = event.target.value;
      const farm = FARM_LIST.find(f => f.ubn === selectedUBN);
      if (farm) {
        document.getElementById("farmNameHint").textContent = `Selected Farm: ${farm.name} (${farm.country})`;
        document.getElementById("userInput").focus();
      }
    }

    // Populate farm dropdown
    document.getElementById("farmSearch").addEventListener('input', (e) => filterFarms(e.target.value));
    document.getElementById("farmSelect").addEventListener('change', handleFarmSelection);

    // Initialize farm data
    async function buildFarmIndex() {
      // Example data, in a real case, this could come from a file or API.
      FARM_LIST = [
        { name: "Farm A", country: "NL", ubn: "314112" },
        { name: "Farm B", country: "GB", ubn: "027754901" },
        { name: "Farm C", country: "DE", ubn: "010580072684" }
        // Add more farms as needed
      ];
      populateFarmSelect(FARM_LIST);
    }

    buildFarmIndex(); // Initialize on page load

    // Function to handle sending the farm information to the server
    async function sendToGPT() {
      const selectedUBN = document.getElementById("farmSelect").value;
      if (!selectedUBN) {
        alert("Please select a farm.");
        return;
      }

      const farm = FARM_LIST.find(f => f.ubn === selectedUBN);
      const message = document.getElementById("userInput").value;

      const payload = {
        ubn: farm.ubn,
        message: message
      };

      try {
        const response = await fetch("/your-endpoint", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await response.json();
        document.getElementById("response").innerText = data.response;
      } catch (error) {
        console.error("Error sending request:", error);
        document.getElementById("response").innerText = "Error sending request.";
      }
    }
  </script>
</body>
</html>
