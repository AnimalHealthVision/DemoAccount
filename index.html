<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Demo account</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="company-description" content="Always respond in the same language as was written.">
  <style>
    body { background-color:#f9f9f9; font-family:Arial,sans-serif; height:100vh; margin:0; }

    /* Password gate */
    #gate { position:fixed; inset:0; background:#0b172033; display:flex; align-items:center; justify-content:center; z-index:9999; backdrop-filter:blur(6px); }
    .gate-card { background:#fff; width:90%; max-width:420px; padding:24px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.15); text-align:center; }
    .gate-card h3 { margin:0 0 8px; color:#007b5e; }
    .gate-card p { margin:0 0 16px; color:#555; }
    .gate-card input[type="password"]{ width:100%; padding:12px; font-size:16px; border:1px solid #ccc; border-radius:8px; margin-bottom:12px; }
    .gate-card button{ width:100%; padding:12px; font-size:16px; border:none; border-radius:8px; background:#007b5e; color:#fff; cursor:pointer; }
    .gate-card button:hover{ background:#005c49; }
    .gate-error{ color:#c02727; min-height:22px; margin-top:8px; font-size:14px; }

    #app{ display:none; }

    /* App card */
    .wrap{ display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding-top:30px; }
    .chat-box{
      background:#fff; padding:30px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.1);
      width:90%; max-width:1100px; /* was 900px → iets wijder gemaakt */
      text-align:center; margin:30px auto;
    }
    img.logo{ width:150px; margin-bottom:10px; }
    h1{ color:#007b5e; margin:10px 0 5px 0; font-size:32px; }
    h2{ color:#555; margin:0 0 10px 0; font-size:16px; font-weight:normal; }

    /* Controls */
    .field-wrap { width:90%; margin:0 auto 10px; text-align:left; }
    .field-wrap input,
    .field-wrap button,
    .field-wrap select {
      width:100%;
      padding:12px;
      font-size:16px;
      border:1px solid #ccc;
      border-radius:6px;
      box-sizing:border-box;
    }
    button{ background-color:#007b5e; color:#fff; cursor:pointer; }
    button:hover{ background-color:#005c49; }

    .control-row { width:90%; margin:4px auto 6px; display:flex; align-items:center; gap:10px; text-align:left; }
    .control-row input[type="checkbox"]{ width:auto; margin:0; }
    .control-row label{ font-size:14px; color:#555; user-select:none; }

    #presetWrap { display:none; }
    #presetSelect option[disabled] { color:#9aa0a6; }

    pre{
      margin:20px auto 0;
      text-align:left;
      background:#f0f0f0;
      padding:15px;
      border-radius:6px;
      white-space:pre-wrap;
      word-wrap:break-word;
      min-height:50px;
      width:100%; /* was 96% → volledig binnen de bredere kaart */
      box-sizing:border-box;
    }

    .download-row{
      display:none;
      width:100%;
      margin:8px auto 0;
      gap:8px;
      justify-content:flex-start;
      align-items:center;
      flex-wrap:wrap;
    }
    .small-btn{
      padding:8px 12px;
      font-size:14px;
      border-radius:6px;
      border:1px solid #0a6b55;
      background:#007b5e;
      color:#fff;
      cursor:pointer;
    }
    .small-btn:hover{ background:#005c49; }

    /* Hint onder UBN */
    .hint { font-size:13px; color:#4b5563; margin-top:6px; }
    .hint .ok { color:#065f46; }
    .hint .warn { color:#9a3412; }

    /* Preview blok */
    .file-preview{ margin-top:10px; text-align:left; font-size:14px; color:#374151; background:#f9fafb; border:1px dashed #d1d5db; padding:10px; border-radius:8px; }
    .file-preview img{ max-width:100%; height:auto; border-radius:6px; }

    @media (max-width: 640px) {
      .chat-box{ padding:20px; width:95%; }
      img.logo{ width:120px; }
      h1{ font-size:26px; }
      h2{ font-size:14px; }
      .field-wrap, .control-row{ width:100%; }
      pre{ width:100%; font-size:14px; }
      .download-row{ width:100%; }
    }

    /* caret + animaties */
    .typing-caret::after { content: "▍"; animation: blink 1s steps(1) infinite; }
    @keyframes blink { 50% { opacity: 0; } }
    .thinking::after { content: " ."; animation: dots 1.2s steps(3, end) infinite; }
    @keyframes dots {
      0% { content: " ."; }
      33% { content: " .."; }
      66% { content: " ..."; }
      100% { content: " ."; }
    }
  </style>
</head>
<body>

  <!-- Password gate -->
  <div id="gate" aria-modal="true" role="dialog">
    <div class="gate-card">
      <h3>AHV secure demo</h3>
      <p>Enter the password to continue.</p>
      <input id="pw" type="password" placeholder="Password" autocomplete="current-password" />
      <button id="enter">Unlock</button>
      <div class="gate-error" id="gateError"></div>
    </div>
  </div>

  <!-- App -->
  <div id="app">
    <div class="wrap">
      <div class="chat-box">
        <img class="logo" src="ahv-logo.jpg" alt="AHV logo" />
        <h1>Demo account</h1>

        <!-- Intro -->
        <h2>In this demo, you can ask questions about the farm, cows, or sales from the past 12 months.</h2>

        <!-- Nieuwe: Zoekbare dropdown met farms (met Farm Identifier) -->
        <div class="field-wrap" id="farmPickerWrap">
          <label for="farmSearch" style="display:block; font-size:14px; color:#555; margin-bottom:6px;">Select a farm</label>
          <input id="farmSearch" placeholder="Farm Identifier (e.g. 314112)">
        </div>
        <div class="field-wrap">
          <select id="farmSelect" aria-label="Select a farm by name and country">
            <option value="">— Select a farm —</option>
          </select>
        </div>

        <div class="field-wrap">
          <!-- Het veld voor de UBN is niet meer zichtbaar. -->
          <div id="farmNameHint" class="hint" aria-live="polite"></div>
          <div id="selectedFarmNote" class="hint"></div>
        </div>

        <!-- Free text (shown when presets are OFF) -->
        <div id="userInputWrap" class="field-wrap">
          <input id="userInput" placeholder="Type your question here in English, Dutch, German or French ..." />
        </div>

        <!-- Preset dropdown (shown when presets are ON) -->
        <div id="presetWrap" class="field-wrap">
          <select id="presetSelect" aria-label="Suggested questions">
            <option value="">— Choose a preset question —</option>
            <option value="Q1_CrossUpsell">Analyze the last 12 months of orders and herd data; identify missing product families and cross-sell or upsell opportunities.</option>
            <option value="Q2_SaleChanceThisMonth">Using last order date and revenue trends, estimate the chance of a new sale if I visit this month.</option>
            <option value="Q3_DryOff_20_25kg">From the latest MPR, what % of cows expected to dry off in the next 30 days are producing over 20 kg and over 25 kg milk?</option>
            <option value="Q4_FPR_Le60DIM">For cows ≤60 DIM in the latest MPR, what % have FPR ≥1.40 at first and second milk recording?</option>
            <option value="Q5_MilkCurve_0_100DIM">Show the herd’s average milk yield curve from calving to 100 DIM using the last 12 months of MPR data and note any >30% drops.</option>
            <option value="Q6_SCC_Bands_LatestMPR">In the latest MPR, how many cows have SCC >200k (heifers >100k)? Indicate chronic vs good-prognosis animals.</option>
            <option value="Q7_SCC_DryOff_vs_PostCalving">Compare SCC before dry-off and first SCC after calving for cows dried off in the last 6 months; summarize udder health changes.</option>
            <option value="Q8_FreshCows_0_100DIM">For cows ≤100 DIM in the latest MPR, compare milk yield vs expected, flag ketosis risk and FPR ≥1.40, and mark ≥30% milk drops.</option>
            <option value="Q9_DryOff_3Months">How many cows are due to dry off in the next 3 months and what is their current milk yield?</option>
            <option value="Q10_RiskLists">Create three lists from the latest MPR: metabolic risk, active udder protocol need (DIM 7–100 & SCC ≥100k), and dry-off risk (milk >20kg and/or SCC >200k within 30 days).</option>
          </select>
        </div>

        <!-- Toggle BELOW whichever input is shown -->
        <div class="control-row">
          <input type="checkbox" id="togglePresets" />
          <label for="togglePresets">Show suggested questions</label>
        </div>

        <div class="field-wrap">
          <button onclick="sendToGPT()" id="sendBtn">Send</button>
        </div>

        <pre id="response">Answer will appear here...</pre>

        <!-- Download buttons (hidden until final response exists) -->
        <div class="download-row" id="downloadRow">
          <button class="small-btn" onclick="downloadDocx()">Download .docx</button>
          <button class="small-btn" onclick="downloadPDF()">Download PDF</button>
        </div>
      </div>

      <!-- Use case 3: AHV / Foto Upload Sectie -->
      <div class="chat-box" id="photoBox">
        <h2>Upload a photo of the completed treatment card using your phone</h2>
        <div class="field-wrap">
          <input type="file" id="imageUpload" accept="image/png,image/jpeg" />
        </div>
        <div class="field-wrap">
          <button onclick="uploadImage()" id="imageBtn">Verstuur</button>
        </div>
        <pre id="imageResponse">Answer will appear here...</pre>
        <!-- Hidden until output is created -->
        <button id="openEditorFromImage" class="small-btn" style="display:none;">Open editor</button>

        <div class="file-preview" id="filePreview"></div>

        <!-- CSV Editor -->
        <div id="csvEditorWrap">
          <h3>Behandelkaart (bewerken & bevestigen)</h3>
          <div class="field-wrap">
            <div style="max-height:420px; overflow:auto; border:1px solid #e5e7eb; border-radius:8px;">
              <table id="csvEditorTable" class="csv-edit" aria-label="Behandelkaart editor"></table>
            </div>
            <div class="editor-actions">
              <button id="addRowBtn" class="small-btn" style="background:#2563eb; border-color:#1d4ed8;">Add row</button>
              <button id="deleteRowBtn" class="small-btn" style="background:#ef4444; border-color:#dc2626;">Delete row</button>
              <button id="confirmCsvBtn" class="small-btn">Confirm (download CSV)</button>
              <button id="submitCsvBtn" class="small-btn" style="background:#0b5; border-color:#0a6b55;">Submit treatment record</button>
              <span id="submitStatus" class="status-chip">Status</span>
              <button id="cancelCsvBtn" class="small-btn" style="background:#6b7280; border-color:#6b7280;">Cancel</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- DOCX + PDF helpers -->
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    const PASS_HASH = "234f1d8746bbd3d0b3a236243b96f8c353c7625c4af41f3d86aac4f239a7e2d0"; // SHA-256 of "AHVDemo123!"
    const SCENARIO2_URL = "https://hook.eu2.make.com/8dm926y2ted2rqsh7m5ggqg0r6qehfz1";
    const SCENARIO1_URL = "https://hook.eu2.make.com/u2luxbx3o1wihpsbysz8gelret1x0jze";
    const PHOTO_URL = SCENARIO1_URL; // foto-upload gebruikt zelfde endpoint als use case 1
    const CORRECTION_URL = "https://hook.eu2.make.com/n16792joe3us6eo41o4x9efbj9r582c6";
    const TYPE_SPEED = 25;
    const TYPE_SPEED_S2 = 40;
    let runIdCounter = 0;
    let currentRunId = 0;

    const CSV_PATH = "CountryCodes (6).csv"; // zelfde map als index.html
    const FARM_INDEX = new Map(); // key: ubn, value: {name, country}
    let FARMS = []; // [{ubn, name, country}]

    function parseCSV(text) {
      const rows = [];
      let i = 0, field = "", row = [], inQuotes = false;
      while (i < text.length) {
        const ch = text[i];
        if (inQuotes) {
          if (ch === '"') {
            if (text[i + 1] === '"') { field += '"'; i += 2; continue; }
            inQuotes = false; i++; continue; }
          else { field += ch; i++; continue; }
        } else {
          if (ch === '"') { inQuotes = true; i++; continue; }
          if (ch === ',') { row.push(field); field = ""; i++; continue; }
          if (ch === '\n' || ch === '\r') {
            if (ch === '\r' && text[i + 1] === '\n') i++;
            row.push(field); rows.push(row); field = ""; row = []; i++; continue; }
          field += ch; i++; }
      }
      if (field.length || row.length) { row.push(field); rows.push(row); }
      return rows;
    }

    function normalizeUBN(v) {
      return String(v ?? "").replace(/[^\d]/g, "");
    }

    async function buildFarmIndex() {
      try {
        const res = await fetch(CSV_PATH, { cache: "no-store" });
        if (!res.ok) throw new Error("CSV not found");
        const text = await res.text();
        const rows = parseCSV(text).filter(r => r.length && r.some(x => x && String(x).trim().length));
        if (!rows.length) return;

        const header = rows[0].map(h => String(h).trim().toLowerCase());
        const ubnIdx   = header.indexOf("ubn");
        const nameIdx  = header.indexOf("farm_name");
        const ccIdx    = header.indexOf("country_code");
        const nameIdxAlt = nameIdx >= 0 ? nameIdx : header.findIndex(h => /name/i.test(h));
        const ubnIdxAlt  = ubnIdx  >= 0 ? ubnIdx  : header.findIndex(h => /ubn|id|identifier/i.test(h));

        const u = ubnIdx >= 0 ? ubnIdx : ubnIdxAlt;
        const n = nameIdx >= 0 ? nameIdx : nameIdxAlt;

        FARMS = [];
        for (let r = 1; r < rows.length; r++) {
          const cells = rows[r];
          const key = normalizeUBN(cells[u] ?? "");
          const name = (cells[n] ?? "").toString().trim();
          const country = ccIdx >= 0 ? (cells[ccIdx] ?? "").toString().trim() : "";
          if (key) {
            FARM_INDEX.set(key, { name, country });
            FARMS.push({ ubn: key, name, country });
          }
        }
        populateFarmSelect(FARMS);
      } catch (e) {
        console.warn("Farm index build failed:", e);
      }
    }

    function showFarmNameForUBN(rawUBN) {
      const hint = document.getElementById("farmNameHint");
      const key = normalizeUBN(rawUBN);
      if (!key) { hint.textContent = ""; return; }

      const rec = FARM_INDEX.get(key);
      if (rec && rec.name) {
        hint.innerHTML = `<span class="ok">( ${rec.name}${rec.country ? " — " + rec.country : ""} )</span>`;
      } else {
        hint.innerHTML = `<span class="warn">( UBN onbekend )</span>`;
      }
    }

    // === nieuwe helpers: dropdown + search ===
    function optionLabel(f) {
      return `${f.name}${f.country ? " — " + f.country : ""} (${f.ubn})`; // Farm name + country + UBN
    }

    function populateFarmSelect(list){
      const sel = document.getElementById("farmSelect");
      sel.innerHTML = `<option value="">— Select a farm —</option>`;
      const frag = document.createDocumentFragment();
      list.forEach(f => {
        const opt = document.createElement("option");
        opt.value = f.ubn;               // waarde = UBN
        opt.textContent = optionLabel(f); // getoond: "Naam — CC (UBN)"
        frag.appendChild(opt);
      });
      sel.appendChild(frag);
    }

    function filterFarms(query){
      const q = (query || "").trim().toLowerCase();
      if (!q) { populateFarmSelect(FARMS); return; }
      const filtered = FARMS.filter(f => {
        const label = optionLabel(f).toLowerCase();
        return label.includes(q) || f.ubn.includes(q);
      });
      populateFarmSelect(filtered);
    }

    // init
    buildFarmIndex();

    async function sha256Hex(str) {
      const buf = new TextEncoder().encode(str);
      const hash = await crypto.subtle.digest("SHA-256", buf);
      return [...new Uint8Array(hash)].map(b => b.toString(16).padStart(2,"0")).join("");
    }

    async function unlock() {
      const pw = document.getElementById("pw").value || "";
      const err = document.getElementById("gateError");
      const hex = await sha256Hex(pw);
      if (hex === PASS_HASH) {
        document.getElementById("gate").style.display = "none";
        document.getElementById("app").style.display = "block";
        setTimeout(() => {
          const t = document.getElementById("togglePresets").checked;
          (t ? document.getElementById("presetSelect") : document.getElementById("userInput")).focus();
        }, 0);
      } else {
        err.textContent = "Incorrect password.";
      }
    }
    document.getElementById("enter").addEventListener("click", unlock);
    document.getElementById("pw").addEventListener("keydown", e => { if (e.key === "Enter") unlock(); });

    const togglePresets = document.getElementById("togglePresets");
    const presetWrap   = document.getElementById("presetWrap");
    const presetSelect = document.getElementById("presetSelect");
    const userInputWrap= document.getElementById("userInputWrap");
    const userInputEl  = document.getElementById("userInput");
    const ubnInputEl   = document.getElementById("ubnInput");

    function updateMode() {
      const on = togglePresets.checked;
      presetWrap.style.display   = on ? "block" : "none";
      userInputWrap.style.display= on ? "none"  : "block";
      if (on) { userInputEl.value = ""; presetSelect.focus(); }
      else    { presetSelect.value = ""; userInputEl.focus(); }
    }
    togglePresets.addEventListener("change", updateMode);

    // === events: farm search + select ===
    const farmSearchEl = document.getElementById("farmSearch");
    const farmSelectEl = document.getElementById("farmSelect");
    const selectedFarmNoteEl = document.getElementById("selectedFarmNote");

    farmSearchEl.addEventListener("input", (e) => {
      filterFarms(e.target.value);
    });

    farmSelectEl.addEventListener("change", (e) => {
      const ubn = normalizeUBN(e.target.value || "");
      if (!ubn) {
        selectedFarmNoteEl.textContent = "";
        return;
      }
      // Zet UBN direct zonder zichtbaar input veld
      ubnInputEl.value = ubn;
      // Toon naam + CC + UBN onder dropdown
      const rec = FARM_INDEX.get(ubn);
      if (rec) {
        selectedFarmNoteEl.innerHTML = `<span class="ok">Selected: ${rec.name}${rec.country ? " — " + rec.country : ""} (UBN: ${ubn})</span>`;
      } else {
        selectedFarmNoteEl.textContent = "";
      }
    });

    /* =========================
       Tekst helpers voor animaties
       ========================= */
    function showFinishing(el, prefixText = "") {
      const base = prefixText ? (prefixText + "\n\n") : "";
      el.textContent = base + "Finishing";
      el.classList.add("thinking");
    }
    function clearThinking(el) {
      el.classList.remove("thinking");
    }
    function startAnalyzingCountdown(el, seconds, prefixText = "", onDone) {
      let s = seconds;
      const base = prefixText ? (prefixText + "\n\n") : "";
      el.classList.add("thinking");
      el.textContent = base + `Analyzing (${s}s)`;
      const id = setInterval(() => {
        s--;
        if (s > 0) {
          el.textContent = base + `Analyzing (${s}s)`;
        } else {
          clearInterval(id);
          if (typeof onDone === "function") onDone();
          else showFinishing(el, prefixText);
        }
      }, 1000);
      return id;
    }
    async function typeOut(text, el, opts = {}) {
      const speed = opts.speed ?? 25;
      const clear = opts.clear ?? true;
      const content = String(text ?? "");
      if (clear) el.textContent = "";
      el.classList.add("typing-caret");
      const lines = content.split(/\n/);
      for (let i = 0; i < lines.length; i++) {
        const tokens = lines[i].split(/(\s+)/);
        for (const t of tokens) {
          el.textContent += t;
          await new Promise(r => setTimeout(r, speed));
        }
        if (i < lines.length - 1) {
          el.textContent += "\n";
          await new Promise(r => setTimeout(r, speed * 6));
        }
      }
      el.classList.remove("typing-caret");
    }
    function stripJsonBlocks(raw){
      if (!raw) return "";
      let t = String(raw);
      t = t.replace(/```[\s\S]*?```/g, "");
      function stripBalancedJson(s, open, close){
        let out = "", depth = 0, buf = "";
        for (let i = 0; i < s.length; i++){
          const ch = s[i];
          if (ch === open){
            if (depth++ === 0){ buf = ""; continue; }
          } else if (ch === close && depth > 0){
            if (--depth === 0){
              const content = buf;
              const looksJson = content.includes(":") && content.replace(/\s/g,"").length > 40;
              if (!looksJson) out += open + content + close;
              continue;
            }
          }
          if (depth > 0) buf += ch; else out += ch;
        }
        return out;
      }
      t = stripBalancedJson(t, "{", "}");
      t = stripBalancedJson(t, "[", "]");
      t = t.split("\n").filter(line => {
        const trimmed = line.trim();
        const looksInlineJson = (/^(\{|\[).*(\:).*(\}|\])$/.test(trimmed) && trimmed.length > 20);
        return !looksInlineJson;
      }).join("\n");
      t = t.replace(/[ \t]*,\s*\n/g, "\n");
      t = t.replace(/\n{3,}/g, "\n\n");
      return t.trim();
    }
    async function fetchText(url, payload){
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      return await res.text();
    }
  </script>
</body>
</html>
