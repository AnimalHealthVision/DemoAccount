<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Demo account</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="company-description" content="Always respond in the same language as was written.">
  <style>
    body { background-color:#f9f9f9; font-family:Arial,sans-serif; height:100vh; margin:0; }

    /* Password gate */
    #gate { position:fixed; inset:0; background:#0b172033; display:flex; align-items:center; justify-content:center; z-index:9999; backdrop-filter:blur(6px); }
    .gate-card { background:#fff; width:90%; max-width:420px; padding:24px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.15); text-align:center; }
    .gate-card h3 { margin:0 0 8px; color:#007b5e; }
    .gate-card p { margin:0 0 16px; color:#555; }
    .gate-card input[type="password"]{ width:100%; padding:12px; font-size:16px; border:1px solid #ccc; border-radius:8px; margin-bottom:12px; }
    .gate-card button{ width:100%; padding:12px; font-size:16px; border:none; border-radius:8px; background:#007b5e; color:#fff; cursor:pointer; }
    .gate-card button:hover{ background:#005c49; }
    .gate-error{ color:#c02727; min-height:22px; margin-top:8px; font-size:14px; }

    #app{ display:none; }

    /* App card */
    .wrap{ display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding-top:30px; }
    .chat-box{
      background:#fff; padding:30px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.1);
      width:90%; max-width:740px;
      text-align:center; margin:30px auto;
    }
    img.logo{ width:150px; margin-bottom:10px; }
    h1{ color:#007b5e; margin:10px 0 5px 0; font-size:32px; }
    h2{ color:#555; margin:0 0 10px 0; font-size:16px; font-weight:normal; }

    /* Farm identifiers table */
    .farm-table{
      width:90%; margin:12px auto; border-collapse:collapse; font-size:15px; background:#fff;
    }
    .farm-table th, .farm-table td{ border:1px solid #e0e0e0; padding:10px; }
    .farm-table th{ background:#f3f6f5; color:#007b5e; text-align:center; }
    .farm-table td{ text-align:center; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    /* Controls */
    .field-wrap { width:90%; margin:0 auto 10px; }
    .field-wrap input,
    .field-wrap button,
    .field-wrap select {
      width:100%;
      padding:12px;
      font-size:16px;
      border:1px solid #ccc;
      border-radius:6px;
      box-sizing:border-box;
    }
    button{ background-color:#007b5e; color:#fff; cursor:pointer; }
    button:hover{ background-color:#005c49; }

    .control-row { width:90%; margin:4px auto 6px; display:flex; align-items:center; gap:10px; text-align:left; }
    .control-row input[type="checkbox"]{ width:auto; margin:0; }
    .control-row label{ font-size:14px; color:#555; user-select:none; }

    #presetWrap { display:none; }
    #presetSelect option[disabled] { color:#9aa0a6; }

    pre{
      margin:20px auto 0;
      text-align:left;
      background:#f0f0f0;
      padding:15px;
      border-radius:6px;
      white-space:pre-wrap;
      word-wrap:break-word;
      min-height:50px;
      width:96%;
      box-sizing:border-box;
    }

    .download-row{
      display:none; /* <- blijft verborgen tot S1 klaar is */
      width:96%;
      margin:8px auto 0;
      gap:8px;
      justify-content:flex-start;
      align-items:center;
      flex-wrap:wrap;
    }
    .small-btn{
      padding:8px 12px;
      font-size:14px;
      border-radius:6px;
      border:1px solid #0a6b55;
      background:#007b5e;
      color:#fff;
      cursor:pointer;
    }
    .small-btn:hover{ background:#005c49; }

    @media (max-width: 640px) {
      .chat-box{ padding:20px; width:95%; }
      img.logo{ width:120px; }
      h1{ font-size:26px; }
      h2{ font-size:14px; }
      .field-wrap, .control-row{ width:100%; }
      pre{ width:100%; font-size:14px; }
      .download-row{ width:100%; }
    }

    /* caret + "Analyzing..." animatie (bewegende puntjes) */
    .typing-caret::after { content: "▍"; animation: blink 1s steps(1) infinite; }
    @keyframes blink { 50% { opacity: 0; } }

    .thinking::after { content: " ."; animation: dots 1.2s steps(3, end) infinite; }
    @keyframes dots {
      0% { content: " ."; }
      33% { content: " .."; }
      66% { content: " ..."; }
      100% { content: " ."; }
    }
  </style>
</head>
<body>

  <!-- Password gate -->
  <div id="gate" aria-modal="true" role="dialog">
    <div class="gate-card">
      <h3>AHV secure demo</h3>
      <p>Enter the password to continue.</p>
      <input id="pw" type="password" placeholder="Password" autocomplete="current-password" />
      <button id="enter">Unlock</button>
      <div class="gate-error" id="gateError"></div>
    </div>
  </div>

  <!-- App -->
  <div id="app">
    <div class="wrap">
      <div class="chat-box">
        <img class="logo" src="ahv-logo.jpg" alt="AHV logo" />
        <h1>Demo account</h1>

        <!-- Text + table -->
        <h2>In this demo, you can ask questions about the farm, cows, or sales from the past 12 months for the following farms:</h2>
        <table class="farm-table" aria-label="Farm identifiers per country">
          <thead>
            <tr><th>NL</th><th>GB</th><th>DE</th><th>FR</th><th>BE</th></tr>
          </thead>
          <tbody>
            <tr><td>406051</td><td>027754901</td><td>033570182014</td><td>22272100</td><td>1102314969</td></tr>
            <tr><td>412980</td><td>066526303</td><td>141882600093</td><td>29274489</td><td>1301704331</td></tr>
            <tr><td>527002</td><td>901062000</td><td>143795003300</td><td>42213083</td><td>4300202077</td></tr>
            <tr><td>530295</td><td>901239700</td><td>160710110010</td><td>50189022</td><td>4300605134</td></tr>
            <tr><td>600345</td><td>902626200</td><td>DE010550444423</td><td>50551254</td><td>4601600477</td></tr>
            <tr><td>6313605</td><td>909502900</td><td></td><td>56144020</td><td></td></tr>
          </tbody>
        </table>

        <div class="field-wrap">
          <input id="ubnInput" placeholder="Enter your UBN (farm registration number)..." />
        </div>

        <!-- Free text (shown when presets are OFF) -->
        <div id="userInputWrap" class="field-wrap">
          <input id="userInput" placeholder="Type your question here in English, Dutch, German or French ..." />
        </div>

        <!-- Preset dropdown (shown when presets are ON) -->
        <div id="presetWrap" class="field-wrap">
          <select id="presetSelect" aria-label="Suggested questions">
            <option value="">— Choose a preset question —</option>
            <option value="Q1_CrossUpsell">Analyze the last 12 months of orders and herd data; identify missing product families and cross-sell or upsell opportunities.</option>
            <option value="Q2_SaleChanceThisMonth">Using last order date and revenue trends, estimate the chance of a new sale if I visit this month.</option>
            <option value="Q3_DryOff_20_25kg">From the latest MPR, what % of cows expected to dry off in the next 30 days are producing over 20 kg and over 25 kg milk?</option>
            <option value="Q4_FPR_Le60DIM">For cows ≤60 DIM in the latest MPR, what % have FPR ≥1.40 at first and second milk recording?</option>
            <option value="Q5_MilkCurve_0_100DIM">Show the herd’s average milk yield curve from calving to 100 DIM using the last 12 months of MPR data and note any >30% drops.</option>
            <option value="Q6_SCC_Bands_LatestMPR">In the latest MPR, how many cows have SCC >200k (heifers >100k)? Indicate chronic vs good-prognosis animals.</option>
            <option value="Q7_SCC_DryOff_vs_PostCalving">Compare SCC before dry-off and first SCC after calving for cows dried off in the last 6 months; summarize udder health changes.</option>
            <option value="Q8_FreshCows_0_100DIM">For cows ≤100 DIM in the latest MPR, compare milk yield vs expected, flag ketosis risk and FPR ≥1.40, and mark ≥30% milk drops.</option>
            <option value="Q9_DryOff_3Months">How many cows are due to dry off in the next 3 months and what is their current milk yield?</option>
            <option value="Q10_RiskLists">Create three lists from the latest MPR: metabolic risk, active udder protocol need (DIM 7–100 & SCC ≥100k), and dry-off risk (milk >20kg and/or SCC >200k within 30 days).</option>
          </select>
        </div>

        <!-- Toggle BELOW whichever input is shown -->
        <div class="control-row">
          <input type="checkbox" id="togglePresets" />
          <label for="togglePresets">Show suggested questions</label>
        </div>

        <div class="field-wrap">
          <button onclick="sendToGPT()" id="sendBtn">Send</button>
        </div>

        <pre id="response">Answer will appear here...</pre>

        <!-- Download buttons (hidden until final response exists) -->
        <div class="download-row" id="downloadRow">
          <button class="small-btn" onclick="downloadDocx()">Download .docx</button>
          <button class="small-btn" onclick="downloadPDF()">Download PDF</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DOCX + PDF helpers -->
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    const PASS_HASH = "234f1d8746bbd3d0b3a236243b96f8c353c7625c4af41f3d86aac4f239a7e2d0"; // SHA-256 of "AHVDemo123!"

    // Scenario URLs
    const SCENARIO2_URL = "https://hook.eu2.make.com/8dm926y2ted2rqsh7m5ggqg0r6qehfz1";
    const SCENARIO1_URL = "https://hook.eu2.make.com/u2luxbx3o1wihpsbysz8gelret1x0jze";

    const TYPE_SPEED = 25;       // basis (gebruikt voor S1)
    const TYPE_SPEED_S2 = 40;    // langzamer typen voor S2
    let runIdCounter = 0;
    let currentRunId = 0;

    async function sha256Hex(str) {
      const buf = new TextEncoder().encode(str);
      const hash = await crypto.subtle.digest("SHA-256", buf);
      return [...new Uint8Array(hash)].map(b => b.toString(16).padStart(2,"0")).join("");
    }

    async function unlock() {
      const pw = document.getElementById("pw").value || "";
      const err = document.getElementById("gateError");
      const hex = await sha256Hex(pw);
      if (hex === PASS_HASH) {
        document.getElementById("gate").style.display = "none";
        document.getElementById("app").style.display = "block";
        setTimeout(() => {
          const t = document.getElementById("togglePresets").checked;
          (t ? document.getElementById("presetSelect") : document.getElementById("userInput")).focus();
        }, 0);
      } else {
        err.textContent = "Incorrect password.";
      }
    }
    document.getElementById("enter").addEventListener("click", unlock);
    document.getElementById("pw").addEventListener("keydown", e => { if (e.key === "Enter") unlock(); });

    const companyName = "TestAccount";
    const companyDescription = document.querySelector('meta[name="company-description"]').content;

    // Language detection
    function detectLanguageFixed(text) {
      const t = (text || "").trim().toLowerCase();
      if (!t) return null;
      const nl=/\b(hoe|waarom|wanneer|welke|met|en|de|het|een|koe|uier|celgetal|omzet|factuur)\b/;
      const fr=/\b(quoi|pourquoi|quand|le|la|les|des|vache|mamelle|cellules|facture|chiffre)\b/;
      const de=/\b(was|warum|wann|welche|und|die|der|das|kuh|euter|zellen|rechnung|umsatz)\b/;
      const en=/\b(what|why|when|which|and|the|cow|udder|cells|invoice|revenue)\b/;
      if (nl.test(t)) return "nl";
      if (fr.test(t)) return "fr";
      if (de.test(t)) return "de";
      if (en.test(t)) return "en";
      const nav=(navigator.language||navigator.userLanguage||"nl").slice(0,2);
      if (["nl","en","fr","de"].includes(nav)) return nav;
      return "nl";
    }

    const togglePresets = document.getElementById("togglePresets");
    const presetWrap   = document.getElementById("presetWrap");
    const presetSelect = document.getElementById("presetSelect");
    const userInputWrap= document.getElementById("userInputWrap");
    const userInputEl  = document.getElementById("userInput");

    function updateMode() {
      const on = togglePresets.checked;
      presetWrap.style.display   = on ? "block" : "none";
      userInputWrap.style.display= on ? "none"  : "block";
      if (on) { userInputEl.value = ""; presetSelect.focus(); }
      else    { presetSelect.value = ""; userInputEl.focus(); }
    }
    togglePresets.addEventListener("change", updateMode);

    /* ===== "Analyzing..." + dynamische puntjes helper ===== */
    function showAnalyzing(el, prefixText = "") {
      const base = prefixText ? (prefixText + "\n\n") : "";
      el.textContent = base + "Analyzing";
      el.classList.add("thinking"); // zorgt voor bewegende puntjes via CSS
    }
    function clearAnalyzing(el) {
      el.classList.remove("thinking");
    }

    /* ===== Aftellen met "Analyzing" + bewegende puntjes ===== */
    function startAnalyzingCountdown(el, seconds, prefixText = "") {
      let s = seconds;
      const base = prefixText ? (prefixText + "\n\n") : "";
      el.classList.add("thinking");
      el.textContent = base + `Analyzing (${s}s)`;

      const id = setInterval(() => {
        s--;
        if (s > 0) {
          el.textContent = base + `Analyzing (${s}s)`;
        } else {
          clearInterval(id);
          // Laat 'Analyzing' met puntjes doorlopen
          el.textContent = base + "Analyzing";
        }
      }, 1000);

      return id;
    }

    /* ===== Typ-effect ===== */
    async function typeOut(text, el, opts = {}) {
      const speed = opts.speed ?? TYPE_SPEED;
      const clear = opts.clear ?? true;
      const content = String(text ?? "");
      if (clear) el.textContent = "";
      el.classList.add("typing-caret");
      const lines = content.split(/\n/);
      for (let i = 0; i < lines.length; i++) {
        const tokens = lines[i].split(/(\s+)/);
        for (const t of tokens) {
          el.textContent += t;
          await new Promise(r => setTimeout(r, speed));
        }
        if (i < lines.length - 1) {
          el.textContent += "\n";
          await new Promise(r => setTimeout(r, speed * 6));
        }
      }
      el.classList.remove("typing-caret");
    }

    /* ===== Helper: STRICTLY strip JSON & fenced code blocks ===== */
    function stripJsonBlocks(raw){
      if (!raw) return "";
      let t = String(raw);

      // 1) Remove fenced code blocks like ```json ... ``` or ``` ... ```
      t = t.replace(/```[\s\S]*?```/g, "");

      // 2) Remove only JSON-like balanced {...} and [...] chunks (must contain colon and be long enough)
      function stripBalancedJson(s, open, close){
        let out = "", depth = 0, buf = "";
        for (let i = 0; i < s.length; i++){
          const ch = s[i];
          if (ch === open){
            if (depth++ === 0){ buf = ""; continue; }
          } else if (ch === close && depth > 0){
            if (--depth === 0){
              const content = buf;
              const looksJson = content.includes(":") && content.replace(/\s/g,"").length > 40;
              if (!looksJson) out += open + content + close; // keep non-JSON brace text
              continue; // drop JSON-like block
            }
          }
          if (depth > 0) buf += ch; else out += ch;
        }
        return out;
      }
      t = stripBalancedJson(t, "{", "}");
      t = stripBalancedJson(t, "[", "]");

      // 3) Also drop obvious inline JSON lines (start with { or [ and contain a colon)
      t = t.split("\n").filter(line => {
        const trimmed = line.trim();
        const looksInlineJson = (/^(\{|\[).*(\:).*(\}|\])$/.test(trimmed) && trimmed.length > 20);
        return !looksInlineJson;
      }).join("\n");

      // 4) Cleanup
      t = t.replace(/[ \t]*,\s*\n/g, "\n");
      t = t.replace(/\n{3,}/g, "\n\n");

      return t.trim();
    }

    /* ===== Fetch helper ===== */
    async function fetchText(url, payload){
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      return await res.text();
    }

    /* ===== Parallel flow: run S2 en S1 tegelijk, toon S2 eerst ===== */
    async function sendToGPT() {
      const usingPreset = togglePresets.checked;
      const preset_id   = usingPreset ? (presetSelect.value || "") : null;
      const preset_text = usingPreset ? (presetSelect.options[presetSelect.selectedIndex]?.text || "") : null;

      const message = usingPreset ? (preset_text || "").trim()
                                  : (userInputEl.value || "").trim();
      const messageMultipleField = usingPreset ? preset_text : null;

      const ubn = document.getElementById("ubnInput").value.trim();
      const responseEl = document.getElementById("response");
      const dlRow = document.getElementById("downloadRow");
      const sendBtn = document.getElementById("sendBtn");

      // Reset per run
      currentRunId = ++runIdCounter;
      const myRunId = currentRunId;
      responseEl.textContent = "";
      clearAnalyzing(responseEl);
      dlRow.style.display = "none";
      sendBtn.disabled = true;

      const inputLang = detectLanguageFixed(message);
      const requestId = (crypto && crypto.randomUUID)
        ? crypto.randomUUID()
        : (Date.now().toString(36) + Math.random().toString(36).slice(2));

      try {
        const payload = {
          company_name: "TestAccount",
          company_description: document.querySelector('meta[name="company-description"]').content,
          message,
          messageMultipleField,
          question_mode: usingPreset ? "preset" : "free",
          preset_id,
          preset_text,
          input_language: inputLang,
          ubn: ubn || undefined,
          request_id: requestId
        };

        /* === Start beide scenario's parallel === */
        let s2Resolved = false;
        const s2Promise = fetchText(SCENARIO2_URL, payload).then(txt => { s2Resolved = true; return txt; });
        const s1Promise = fetchText(SCENARIO1_URL, payload);

        /* === 1) Eerste 5s: "Analyzing (Xs)" met puntjes === */
        let preCountdownId = startAnalyzingCountdown(responseEl, 5);
        // Na 5s: als S2 nog niet klaar is, blijft "Analyzing" met puntjes doorlopen

        /* === Wacht tot S2 klaar is (kan ook binnen 5s zijn) === */
        const s2Raw = await s2Promise;
        if (myRunId !== currentRunId) return;

        // Ruim eerste countdown op
        clearInterval(preCountdownId);
        clearAnalyzing(responseEl); // animatie uit tijdens typen

        const s2Show = stripJsonBlocks(s2Raw);
        await typeOut(s2Show, responseEl, { clear: true, speed: TYPE_SPEED_S2 }); // LANGZAMER S2

        /* === 2) Na S2: 10s "Analyzing (Xs)" met puntjes voor S1 === */
        if (myRunId !== currentRunId) return;
        let wait10Id = startAnalyzingCountdown(responseEl, 10, s2Show);

        /* === Wacht op S1 === */
        const s1Raw = await s1Promise;
        if (myRunId !== currentRunId) { clearInterval(wait10Id); return; }

        // S1 binnen: countdown stoppen, animatie uit, en S1 tonen
        clearInterval(wait10Id);
        clearAnalyzing(responseEl);

        responseEl.textContent = s2Show + "\n\n";
        const s1Show = stripJsonBlocks(s1Raw);
        await typeOut(s1Show, responseEl, { clear: false, speed: TYPE_SPEED }); // S1 snelheid ONGEWIJZIGD

        // Download-knoppen pas na volledige output
        dlRow.style.display = "flex";

      } catch (err) {
        if (myRunId !== currentRunId) return;
        clearAnalyzing(responseEl);
        responseEl.textContent = "Error: " + err.message;
      } finally {
        if (myRunId === currentRunId) sendBtn.disabled = false;
      }
    }

    // --- Download helpers ---
    function downloadDocx() {
      const { Document, Packer, Paragraph, TextRun } = docx;
      const text = (document.getElementById("response").innerText || "").replace(/\r\n/g, "\n");
      const paragraphs = text.split("\n").map(line => new Paragraph({ children: [new TextRun(line)] }));
      const doc = new Document({ sections: [{ properties: {}, children: paragraphs.length ? paragraphs : [new Paragraph("")] }]});
      Packer.toBlob(doc).then(blob => saveAs(blob, "answer.docx"));
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:"pt", format:"a4" });
      const text = (document.getElementById("response").innerText || "");
      const margin = 40;
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const maxWidth = pageWidth - margin * 2;
      const lines = doc.splitTextToSize(text, maxWidth);
      let y = margin;
      const lineHeight = 16;

      lines.forEach(line => {
        if (y > pageHeight - margin) { doc.addPage(); y = margin; }
        doc.text(line, margin, y);
        y += lineHeight;
      });

      doc.save("answer.pdf");
    }
  </script>
</body>
</html>
